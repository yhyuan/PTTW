# Required packages: arcpy from ArcGIS 10.1
# Input data: 1) A file geodatabase named PTTW contains a feature class named PTTW in a feature dataset named Water tables and a table named PTTW_no_utm. 
#             2) A file geodatabase named PTTW_Search contains the watershed layer (WSHED_TERT_20110530_Simplify) and Water course layer (OHN_WATERCOURSE_20110530)
#             3) mxd, msd files and readme file for PTTW
#             4) field description file (fields_description.txt)
# Output data: 
#       A zip file named PTTW_Search.zip contains a file geodatabase named PTTW, PTTW.mxd, PTTW.msd, readme file. This is the package to LRC. 
#       A zip file named PermitsToTakeWater.zip for shape file on data download page. 
#       A dbf file named PTTW_DataDownload.dbf to create the PTTW.xls for Excel file on data download page. 
#       A file geodatabase named PTTW_NAD83 which contains a feature class named PTTW which is loaded to SDE. 
import sys, string, os
import arcpy
reload(sys)
sys.setdefaultencoding("latin-1")
import pyodbc
import zipfile

# Local variables...
#WSHED_TERT_20110530_Simplify = "Y:\\Public\\PTTW_Search.gdb\\WSHED_TERT_20110530_Simplify"
#OHN_WATERCOURSE_20110530 = "Y:\\Public\\PTTW_Search.gdb\\OHN_WATERCOURSE_20110530"
INPUT_PATH = "input"
WSHED_TERT_20110530_Simplify = INPUT_PATH + "\\PTTW_Search.gdb\\WSHED_TERT_20110530_Simplify"
OHN_WATERCOURSE_20110530 = INPUT_PATH + "\\PTTW_Search.gdb\\OHN_WATERCOURSE_20110530"
INPUT_GDB = INPUT_PATH + "\\PTTW.gdb"
OUTPUT_PATH = "output"
if arcpy.Exists(OUTPUT_PATH + "\\PTTW_Search.gdb"):
	os.system("rmdir " + OUTPUT_PATH + "\\PTTW_Search.gdb /s /q")
os.system("del " + OUTPUT_PATH + "\\*PTTW*.*")
if arcpy.Exists(OUTPUT_PATH + "\\PTTW_NAD83.gdb"):
	os.system("rmdir " + OUTPUT_PATH + "\\PTTW_NAD83.gdb /s /q")

arcpy.CreateFileGDB_management(OUTPUT_PATH, "PTTW_Search", "9.3")
arcpy.CreateFileGDB_management(OUTPUT_PATH, "PTTW_NAD83", "9.3")

OUTPUT_GDB = OUTPUT_PATH + "\\PTTW_Search.gdb"

# Copy the Feature Class and the table to Output GDB
arcpy.FeatureClassToFeatureClass_conversion(INPUT_GDB + "\\Water\\PTTW", OUTPUT_GDB, "PTTW", "", "PERMITNO \"PERMITNO\" true true false 50 Text 0 0 ,First,#,"  + INPUT_GDB + "\\Water\\PTTW,PERMITNO,-1,-1;FILENO \"FILENO\" true true false 200 Text 0 0 ,First,#,"  + INPUT_GDB + "\\Water\\PTTW,FILENO,-1,-1;CLIENTNAME \"CLIENTNAME\" true true false 200 Text 0 0 ,First,#,"  + INPUT_GDB + "\\Water\\PTTW,CLIENTNAME,-1,-1;CLIENTNO \"CLIENTNO\" true true false 150 Text 0 0 ,First,#,"  + INPUT_GDB + "\\Water\\PTTW,CLIENTNO,-1,-1;PURPOSECAT \"PURPOSECAT\" true true false 200 Text 0 0 ,First,#,"  + INPUT_GDB + "\\Water\\PTTW,PURPOSECAT,-1,-1;SPURPOSE \"SPURPOSE\" true true false 200 Text 0 0 ,First,#,"  + INPUT_GDB + "\\Water\\PTTW,SPURPOSE,-1,-1;EXPIRYDATE \"EXPIRYDATE\" true true false 8 Date 0 0 ,First,#,"  + INPUT_GDB + "\\Water\\PTTW,EXPIRYDATE,-1,-1;ISSUEDDATE \"ISSUEDDATE\" true true false 8 Date 0 0 ,First,#,"  + INPUT_GDB + "\\Water\\PTTW,ISSUEDDATE,-1,-1;RENEWDATE \"RENEWDATE\" true true false 50 Text 0 0 ,First,#,"  + INPUT_GDB + "\\Water\\PTTW,RENEWDATE,-1,-1;OLDCTYTWN \"OLDCTYTWN\" true true false 200 Text 0 0 ,First,#,"  + INPUT_GDB + "\\Water\\PTTW,OLDCTYTWN,-1,-1;P_LOT \"P_LOT\" true true false 150 Text 0 0 ,First,#,"  + INPUT_GDB + "\\Water\\PTTW,P_LOT,-1,-1;P_CON \"P_CON\" true true false 150 Text 0 0 ,First,#,"  + INPUT_GDB + "\\Water\\PTTW,P_CON,-1,-1;P_MUNICIP \"P_MUNICIP\" true true false 200 Text 0 0 ,First,#,"  + INPUT_GDB + "\\Water\\PTTW,P_MUNICIP,-1,-1;P_UPPERT \"P_UPPERT\" true true false 150 Text 0 0 ,First,#,"  + INPUT_GDB + "\\Water\\PTTW,P_UPPERT,-1,-1;P_LOWERT \"P_LOWERT\" true true false 200 Text 0 0 ,First,#,"  + INPUT_GDB + "\\Water\\PTTW,P_LOWERT,-1,-1;ADDRESS \"ADDRESS\" true true false 200 Text 0 0 ,First,#,"  + INPUT_GDB + "\\Water\\PTTW,ADDRESS,-1,-1;CITY \"CITY\" true true false 50 Text 0 0 ,First,#,"  + INPUT_GDB + "\\Water\\PTTW,CITY,-1,-1;PROVINCE \"PROVINCE\" true true false 50 Text 0 0 ,First,#,"  + INPUT_GDB + "\\Water\\PTTW,PROVINCE,-1,-1;POSTALCODE \"POSTALCODE\" true true false 50 Text 0 0 ,First,#,"  + INPUT_GDB + "\\Water\\PTTW,POSTALCODE,-1,-1;PHONE \"PHONE\" true true false 50 Text 0 0 ,First,#,"  + INPUT_GDB + "\\Water\\PTTW,PHONE,-1,-1;SURFGRND \"SURFGRND\" true true false 50 Text 0 0 ,First,#,"  + INPUT_GDB + "\\Water\\PTTW,SURFGRND,-1,-1;SOURCEID \"SOURCEID\" true true false 255 Text 0 0 ,First,#,"  + INPUT_GDB + "\\Water\\PTTW,SOURCEID,-1,-1;EASTING \"EASTING\" true true false 8 Double 0 0 ,First,#,"  + INPUT_GDB + "\\Water\\PTTW,EASTING,-1,-1;NORTHING \"NORTHING\" true true false 8 Double 0 0 ,First,#,"  + INPUT_GDB + "\\Water\\PTTW,NORTHING,-1,-1;UTMZONE \"UTMZONE\" true true false 8 Double 0 0 ,First,#,"  + INPUT_GDB + "\\Water\\PTTW,UTMZONE,-1,-1;MAXL_DAY \"MAXL_DAY\" true true false 8 Double 0 0 ,First,#,"  + INPUT_GDB + "\\Water\\PTTW,MAXL_DAY,-1,-1;DAYS_YEAR \"DAYS_YEAR\" true true false 8 Double 0 0 ,First,#,"  + INPUT_GDB + "\\Water\\PTTW,DAYS_YEAR,-1,-1;HRS_DAYMAX \"HRS_DAYMAX\" true true false 8 Double 0 0 ,First,#,"  + INPUT_GDB + "\\Water\\PTTW,HRS_DAYMAX,-1,-1;L_MINUTE \"L_MINUTE\" true true false 8 Double 0 0 ,First,#,"  + INPUT_GDB + "\\Water\\PTTW,L_MINUTE,-1,-1;AMENDED_BY \"AMENDED_BY\" true true false 50 Text 0 0 ,First,#,"  + INPUT_GDB + "\\Water\\PTTW,AMENDED_BY,-1,-1;EXPIRED_BY \"EXPIRED_BY\" true true false 50 Text 0 0 ,First,#,"  + INPUT_GDB + "\\Water\\PTTW,EXPIRED_BY,-1,-1;PERMIT_END \"PERMIT_END\" true true false 8 Date 0 0 ,First,#,"  + INPUT_GDB + "\\Water\\PTTW,PERMIT_END,-1,-1;ORIGEAST \"ORIGEAST\" true true false 8 Double 0 0 ,First,#,"  + INPUT_GDB + "\\Water\\PTTW,ORIGEAST,-1,-1;ORIGNORTH \"ORIGNORTH\" true true false 8 Double 0 0 ,First,#,"  + INPUT_GDB + "\\Water\\PTTW,ORIGNORTH,-1,-1;ACTIVE \"ACTIVE\" true true false 3 Text 0 0 ,First,#,"  + INPUT_GDB + "\\Water\\PTTW,ACTIVE,-1,-1;MUN_CA_AUT \"MUN_CA_AUT\" true true false 50 Text 0 0 ,First,#,"  + INPUT_GDB + "\\Water\\PTTW,MUN_CA_AUT,-1,-1;REFERENCE \"REFERENCE\" true true false 50 Text 0 0 ,First,#,"  + INPUT_GDB + "\\Water\\PTTW,REFERENCE,-1,-1", "")
arcpy.TableToTable_conversion(INPUT_GDB + "\\PTTW_no_UTM", OUTPUT_GDB, "PTTW_no_UTM", "", "PERMITNO \"PERMITNO\" true true false 50 Text 0 0 ,First,#,"  + INPUT_GDB + "\\PTTW_no_UTM,PERMITNO,-1,-1;FILENO \"FILENO\" true true false 200 Text 0 0 ,First,#,"  + INPUT_GDB + "\\PTTW_no_UTM,FILENO,-1,-1;CLIENTNAME \"CLIENTNAME\" true true false 200 Text 0 0 ,First,#,"  + INPUT_GDB + "\\PTTW_no_UTM,CLIENTNAME,-1,-1;CLIENTNO \"CLIENTNO\" true true false 150 Text 0 0 ,First,#,"  + INPUT_GDB + "\\PTTW_no_UTM,CLIENTNO,-1,-1;PURPOSECAT \"PURPOSECAT\" true true false 200 Text 0 0 ,First,#,"  + INPUT_GDB + "\\PTTW_no_UTM,PURPOSECAT,-1,-1;SPURPOSE \"SPURPOSE\" true true false 200 Text 0 0 ,First,#,"  + INPUT_GDB + "\\PTTW_no_UTM,SPURPOSE,-1,-1;EXPIRYDATE \"EXPIRYDATE\" true true false 8 Date 0 0 ,First,#,"  + INPUT_GDB + "\\PTTW_no_UTM,EXPIRYDATE,-1,-1;ISSUEDDATE \"ISSUEDDATE\" true true false 8 Date 0 0 ,First,#,"  + INPUT_GDB + "\\PTTW_no_UTM,ISSUEDDATE,-1,-1;RENEWDATE \"RENEWDATE\" true true false 50 Text 0 0 ,First,#,"  + INPUT_GDB + "\\PTTW_no_UTM,RENEWDATE,-1,-1;OLDCTYTWN \"OLDCTYTWN\" true true false 200 Text 0 0 ,First,#,"  + INPUT_GDB + "\\PTTW_no_UTM,OLDCTYTWN,-1,-1;P_LOT \"P_LOT\" true true false 150 Text 0 0 ,First,#,"  + INPUT_GDB + "\\PTTW_no_UTM,P_LOT,-1,-1;P_CON \"P_CON\" true true false 150 Text 0 0 ,First,#,"  + INPUT_GDB + "\\PTTW_no_UTM,P_CON,-1,-1;P_MUNICIP \"P_MUNICIP\" true true false 200 Text 0 0 ,First,#,"  + INPUT_GDB + "\\PTTW_no_UTM,P_MUNICIP,-1,-1;P_UPPERT \"P_UPPERT\" true true false 150 Text 0 0 ,First,#,"  + INPUT_GDB + "\\PTTW_no_UTM,P_UPPERT,-1,-1;P_LOWERT \"P_LOWERT\" true true false 200 Text 0 0 ,First,#,"  + INPUT_GDB + "\\PTTW_no_UTM,P_LOWERT,-1,-1;ADDRESS \"ADDRESS\" true true false 200 Text 0 0 ,First,#,"  + INPUT_GDB + "\\PTTW_no_UTM,ADDRESS,-1,-1;CITY \"CITY\" true true false 50 Text 0 0 ,First,#,"  + INPUT_GDB + "\\PTTW_no_UTM,CITY,-1,-1;PROVINCE \"PROVINCE\" true true false 50 Text 0 0 ,First,#,"  + INPUT_GDB + "\\PTTW_no_UTM,PROVINCE,-1,-1;POSTALCODE \"POSTALCODE\" true true false 50 Text 0 0 ,First,#,"  + INPUT_GDB + "\\PTTW_no_UTM,POSTALCODE,-1,-1;PHONE \"PHONE\" true true false 50 Text 0 0 ,First,#,"  + INPUT_GDB + "\\PTTW_no_UTM,PHONE,-1,-1;SURFGRND \"SURFGRND\" true true false 50 Text 0 0 ,First,#,"  + INPUT_GDB + "\\PTTW_no_UTM,SURFGRND,-1,-1;SOURCEID \"SOURCEID\" true true false 255 Text 0 0 ,First,#,"  + INPUT_GDB + "\\PTTW_no_UTM,SOURCEID,-1,-1;EASTING \"EASTING\" true true false 8 Double 0 0 ,First,#,"  + INPUT_GDB + "\\PTTW_no_UTM,EASTING,-1,-1;NORTHING \"NORTHING\" true true false 8 Double 0 0 ,First,#,"  + INPUT_GDB + "\\PTTW_no_UTM,NORTHING,-1,-1;UTMZONE \"UTMZONE\" true true false 8 Double 0 0 ,First,#,"  + INPUT_GDB + "\\PTTW_no_UTM,UTMZONE,-1,-1;MAXL_DAY \"MAXL_DAY\" true true false 8 Double 0 0 ,First,#,"  + INPUT_GDB + "\\PTTW_no_UTM,MAXL_DAY,-1,-1;DAYS_YEAR \"DAYS_YEAR\" true true false 8 Double 0 0 ,First,#,"  + INPUT_GDB + "\\PTTW_no_UTM,DAYS_YEAR,-1,-1;HRS_DAYMAX \"HRS_DAYMAX\" true true false 8 Double 0 0 ,First,#,"  + INPUT_GDB + "\\PTTW_no_UTM,HRS_DAYMAX,-1,-1;L_MINUTE \"L_MINUTE\" true true false 8 Double 0 0 ,First,#,"  + INPUT_GDB + "\\PTTW_no_UTM,L_MINUTE,-1,-1;AMENDED_BY \"AMENDED_BY\" true true false 50 Text 0 0 ,First,#,"  + INPUT_GDB + "\\PTTW_no_UTM,AMENDED_BY,-1,-1;EXPIRED_BY \"EXPIRED_BY\" true true false 50 Text 0 0 ,First,#,"  + INPUT_GDB + "\\PTTW_no_UTM,EXPIRED_BY,-1,-1;PERMIT_END \"PERMIT_END\" true true false 8 Date 0 0 ,First,#,"  + INPUT_GDB + "\\PTTW_no_UTM,PERMIT_END,-1,-1;OUTOFUTM \"OUTOFUTM\" true true false 8 Double 0 0 ,First,#,"  + INPUT_GDB + "\\PTTW_no_UTM,OUTOFUTM,-1,-1;ORIGEAST \"ORIGEAST\" true true false 8 Double 0 0 ,First,#,"  + INPUT_GDB + "\\PTTW_no_UTM,ORIGEAST,-1,-1;ORIGNORTH \"ORIGNORTH\" true true false 8 Double 0 0 ,First,#,"  + INPUT_GDB + "\\PTTW_no_UTM,ORIGNORTH,-1,-1;NOUTM \"NOUTM\" true true false 8 Double 0 0 ,First,#,"  + INPUT_GDB + "\\PTTW_no_UTM,NOUTM,-1,-1;ACTIVE \"ACTIVE\" true true false 3 Text 0 0 ,First,#,"  + INPUT_GDB + "\\PTTW_no_UTM,ACTIVE,-1,-1;ID \"ID\" true true false 100 Text 0 0 ,First,#,"  + INPUT_GDB + "\\PTTW_no_UTM,ID,-1,-1;MUN_CA_AUT \"MUN_CA_AUT\" true true false 50 Text 0 0 ,First,#,"  + INPUT_GDB + "\\PTTW_no_UTM,MUN_CA_AUT,-1,-1;REFERENCE \"REFERENCE\" true true false 50 Text 0 0 ,First,#,"  + INPUT_GDB + "\\PTTW_no_UTM,REFERENCE,-1,-1;UNIQUE \"UNIQUE\" true true false 254 Text 0 0 ,First,#,"  + INPUT_GDB + "\\PTTW_no_UTM,UNIQUE,-1,-1;fix \"fix\" true true false 2 Short 0 0 ,First,#,"  + INPUT_GDB + "\\PTTW_no_UTM,fix,-1,-1", "")

# Process the PTTW_no_utm by adding the latitude and longitude with 0 and convert the table to a feature class named PTTW_NO_UTM_Layer. 
arcpy.AddField_management(OUTPUT_GDB + "\\PTTW_no_UTM", "LATITUDE", "DOUBLE", "", "", "", "", "NULLABLE", "NON_REQUIRED", "")
arcpy.AddField_management(OUTPUT_GDB + "\\PTTW_no_UTM", "LONGITUDE", "DOUBLE", "", "", "", "", "NULLABLE", "NON_REQUIRED", "")
arcpy.CalculateField_management(OUTPUT_GDB + "\\PTTW_no_UTM", "LATITUDE", "0", "VB", "")
arcpy.CalculateField_management(OUTPUT_GDB + "\\PTTW_no_UTM", "LONGITUDE", "0", "VB", "")
arcpy.MakeXYEventLayer_management(OUTPUT_GDB + "\\PTTW_no_UTM", "longitude", "latitude", OUTPUT_GDB + "\\PTTW_NO_UTM_Layer", "GEOGCS['GCS_North_American_1983',DATUM['D_North_American_1983',SPHEROID['GRS_1980',6378137.0,298.257222101]],PRIMEM['Greenwich',0.0],UNIT['Degree',0.0174532925199433]];-400 -400 1000000000;0 1;0 1;8.98315284119521E-09;0.001;0.001;IsHighPrecision")
PTTW_no_UTM = OUTPUT_GDB + "\\PTTW_no_UTM"
arcpy.FeatureClassToFeatureClass_conversion(OUTPUT_GDB + "\\PTTW_NO_UTM_Layer", OUTPUT_GDB, "PTTW_NO_UTM_Layer", "", "PERMITNO 'PERMITNO' true true false 50 Text 0 0 ,First,#," +  PTTW_no_UTM + ",PERMITNO,-1,-1;FILENO 'FILENO' true true false 200 Text 0 0 ,First,#," +  PTTW_no_UTM + ",FILENO,-1,-1;CLIENTNAME 'CLIENTNAME' true true false 200 Text 0 0 ,First,#," +  PTTW_no_UTM + ",CLIENTNAME,-1,-1;CLIENTNO 'CLIENTNO' true true false 150 Text 0 0 ,First,#," +  PTTW_no_UTM + ",CLIENTNO,-1,-1;PURPOSECAT 'PURPOSECAT' true true false 200 Text 0 0 ,First,#," +  PTTW_no_UTM + ",PURPOSECAT,-1,-1;SPURPOSE 'SPURPOSE' true true false 200 Text 0 0 ,First,#," +  PTTW_no_UTM + ",SPURPOSE,-1,-1;EXPIRYDATE 'EXPIRYDATE' true true false 8 Date 0 0 ,First,#," +  PTTW_no_UTM + ",EXPIRYDATE,-1,-1;ISSUEDDATE 'ISSUEDDATE' true true false 8 Date 0 0 ,First,#," +  PTTW_no_UTM + ",ISSUEDDATE,-1,-1;RENEWDATE 'RENEWDATE' true true false 50 Text 0 0 ,First,#," +  PTTW_no_UTM + ",RENEWDATE,-1,-1;OLDCTYTWN 'OLDCTYTWN' true true false 200 Text 0 0 ,First,#," +  PTTW_no_UTM + ",OLDCTYTWN,-1,-1;P_LOT 'P_LOT' true true false 150 Text 0 0 ,First,#," +  PTTW_no_UTM + ",P_LOT,-1,-1;P_CON 'P_CON' true true false 150 Text 0 0 ,First,#," +  PTTW_no_UTM + ",P_CON,-1,-1;P_MUNICIP 'P_MUNICIP' true true false 200 Text 0 0 ,First,#," +  PTTW_no_UTM + ",P_MUNICIP,-1,-1;P_UPPERT 'P_UPPERT' true true false 150 Text 0 0 ,First,#," +  PTTW_no_UTM + ",P_UPPERT,-1,-1;P_LOWERT 'P_LOWERT' true true false 200 Text 0 0 ,First,#," +  PTTW_no_UTM + ",P_LOWERT,-1,-1;ADDRESS 'ADDRESS' true true false 200 Text 0 0 ,First,#," +  PTTW_no_UTM + ",ADDRESS,-1,-1;CITY 'CITY' true true false 50 Text 0 0 ,First,#," +  PTTW_no_UTM + ",CITY,-1,-1;PROVINCE 'PROVINCE' true true false 50 Text 0 0 ,First,#," +  PTTW_no_UTM + ",PROVINCE,-1,-1;POSTALCODE 'POSTALCODE' true true false 50 Text 0 0 ,First,#," +  PTTW_no_UTM + ",POSTALCODE,-1,-1;PHONE 'PHONE' true true false 50 Text 0 0 ,First,#," +  PTTW_no_UTM + ",PHONE,-1,-1;SURFGRND 'SURFGRND' true true false 50 Text 0 0 ,First,#," +  PTTW_no_UTM + ",SURFGRND,-1,-1;SOURCEID 'SOURCEID' true true false 255 Text 0 0 ,First,#," +  PTTW_no_UTM + ",SOURCEID,-1,-1;EASTING 'EASTING' true true false 8 Double 0 0 ,First,#," +  PTTW_no_UTM + ",EASTING,-1,-1;NORTHING 'NORTHING' true true false 8 Double 0 0 ,First,#," +  PTTW_no_UTM + ",NORTHING,-1,-1;UTMZONE 'UTMZONE' true true false 8 Double 0 0 ,First,#," +  PTTW_no_UTM + ",UTMZONE,-1,-1;MAXL_DAY 'MAXL_DAY' true true false 8 Double 0 0 ,First,#," +  PTTW_no_UTM + ",MAXL_DAY,-1,-1;DAYS_YEAR 'DAYS_YEAR' true true false 8 Double 0 0 ,First,#," +  PTTW_no_UTM + ",DAYS_YEAR,-1,-1;HRS_DAYMAX 'HRS_DAYMAX' true true false 8 Double 0 0 ,First,#," +  PTTW_no_UTM + ",HRS_DAYMAX,-1,-1;L_MINUTE 'L_MINUTE' true true false 8 Double 0 0 ,First,#," +  PTTW_no_UTM + ",L_MINUTE,-1,-1;AMENDED_BY 'AMENDED_BY' true true false 50 Text 0 0 ,First,#," +  PTTW_no_UTM + ",AMENDED_BY,-1,-1;EXPIRED_BY 'EXPIRED_BY' true true false 50 Text 0 0 ,First,#," +  PTTW_no_UTM + ",EXPIRED_BY,-1,-1;PERMIT_END 'PERMIT_END' true true false 8 Date 0 0 ,First,#," +  PTTW_no_UTM + ",PERMIT_END,-1,-1;OUTOFUTM 'OUTOFUTM' true true false 8 Double 0 0 ,First,#," +  PTTW_no_UTM + ",OUTOFUTM,-1,-1;ORIGEAST 'ORIGEAST' true true false 8 Double 0 0 ,First,#," +  PTTW_no_UTM + ",ORIGEAST,-1,-1;ORIGNORTH 'ORIGNORTH' true true false 8 Double 0 0 ,First,#," +  PTTW_no_UTM + ",ORIGNORTH,-1,-1;NOUTM 'NOUTM' true true false 8 Double 0 0 ,First,#," +  PTTW_no_UTM + ",NOUTM,-1,-1;ACTIVE 'ACTIVE' true true false 3 Text 0 0 ,First,#," +  PTTW_no_UTM + ",ACTIVE,-1,-1;ID 'ID' true true false 100 Text 0 0 ,First,#," +  PTTW_no_UTM + ",ID,-1,-1;MUN_CA_AUT 'MUN_CA_AUT' true true false 50 Text 0 0 ,First,#," +  PTTW_no_UTM + ",MUN_CA_AUT,-1,-1;REFERENCE 'REFERENCE' true true false 50 Text 0 0 ,First,#," +  PTTW_no_UTM + ",REFERENCE,-1,-1;UNIQUE 'UNIQUE' true true false 254 Text 0 0 ,First,#," +  PTTW_no_UTM + ",UNIQUE,-1,-1;fix 'fix' true true false 2 Short 0 0 ,First,#," +  PTTW_no_UTM + ",fix,-1,-1;LATITUDE 'LATITUDE' true true false -1 Double -1 -2 ,First,#," +  PTTW_no_UTM + ",LATITUDE,-1,-1;LONGITUDE 'LONGITUDE' true true false -1 Double -1 -2 ,First,#," +  PTTW_no_UTM + ",LONGITUDE,-1,-1", "")

# Change the PTTW layer projection to NAD83, add latitude and longitude fields and calculate their values. 
arcpy.Project_management(OUTPUT_GDB + "\\PTTW", OUTPUT_GDB + "\\PTTW_NAD83", "GEOGCS['GCS_North_American_1983',DATUM['D_North_American_1983',SPHEROID['GRS_1980',6378137.0,298.257222101]],PRIMEM['Greenwich',0.0],UNIT['Degree',0.0174532925199433]]", "", "PROJCS['MNR_Lambert_Conformal_Conic',GEOGCS['GCS_North_American_1983',DATUM['D_North_American_1983',SPHEROID['GRS_1980',6378137.0,298.257222101]],PRIMEM['Greenwich',0.0],UNIT['Degree',0.0174532925199433]],PROJECTION['Lambert_Conformal_Conic'],PARAMETER['False_Easting',930000.0],PARAMETER['False_Northing',6430000.0],PARAMETER['Central_Meridian',-85.0],PARAMETER['Standard_Parallel_1',44.5],PARAMETER['Standard_Parallel_2',53.5],PARAMETER['Latitude_Of_Origin',0.0],UNIT['Meter',1.0]]")
arcpy.AddField_management(OUTPUT_GDB + "\\PTTW_NAD83", "LATITUDE", "DOUBLE", "", "", "", "", "NULLABLE", "NON_REQUIRED", "")
arcpy.AddField_management(OUTPUT_GDB + "\\PTTW_NAD83", "LONGITUDE", "DOUBLE", "", "", "", "", "NULLABLE", "NON_REQUIRED", "")
yExpression = "float(!SHAPE.CENTROID!.split()[1])"
arcpy.CalculateField_management(OUTPUT_GDB + "\\PTTW_NAD83", "LATITUDE", yExpression, "PYTHON")
xExpression = "float(!SHAPE.CENTROID!.split()[0])"
arcpy.CalculateField_management(OUTPUT_GDB + "\\PTTW_NAD83", "LONGITUDE", xExpression, "PYTHON")

# Append the records from PTTW_no_utm to PTTW layer and remove the PTTW_NO_UTM_Layer layer.
PTTW_NO_UTM_Layer = OUTPUT_GDB + "\\PTTW_NO_UTM_Layer"
arcpy.Append_management(PTTW_NO_UTM_Layer, OUTPUT_GDB + "\\PTTW_NAD83", "NO_TEST", "PERMITNO 'PERMITNO' true true false 50 Text 0 0 ,First,#," + PTTW_NO_UTM_Layer + ",PERMITNO,-1,-1;FILENO 'FILENO' true true false 200 Text 0 0 ,First,#," + PTTW_NO_UTM_Layer + ",FILENO,-1,-1;CLIENTNAME 'CLIENTNAME' true true false 200 Text 0 0 ,First,#," + PTTW_NO_UTM_Layer + ",CLIENTNAME,-1,-1;CLIENTNO 'CLIENTNO' true true false 150 Text 0 0 ,First,#," + PTTW_NO_UTM_Layer + ",CLIENTNO,-1,-1;PURPOSECAT 'PURPOSECAT' true true false 200 Text 0 0 ,First,#," + PTTW_NO_UTM_Layer + ",PURPOSECAT,-1,-1;SPURPOSE 'SPURPOSE' true true false 200 Text 0 0 ,First,#," + PTTW_NO_UTM_Layer + ",SPURPOSE,-1,-1;EXPIRYDATE 'EXPIRYDATE' true true false 8 Date 0 0 ,First,#," + PTTW_NO_UTM_Layer + ",EXPIRYDATE,-1,-1;ISSUEDDATE 'ISSUEDDATE' true true false 8 Date 0 0 ,First,#," + PTTW_NO_UTM_Layer + ",ISSUEDDATE,-1,-1;RENEWDATE 'RENEWDATE' true true false 50 Text 0 0 ,First,#," + PTTW_NO_UTM_Layer + ",RENEWDATE,-1,-1;OLDCTYTWN 'OLDCTYTWN' true true false 200 Text 0 0 ,First,#," + PTTW_NO_UTM_Layer + ",OLDCTYTWN,-1,-1;P_LOT 'P_LOT' true true false 150 Text 0 0 ,First,#," + PTTW_NO_UTM_Layer + ",P_LOT,-1,-1;P_CON 'P_CON' true true false 150 Text 0 0 ,First,#," + PTTW_NO_UTM_Layer + ",P_CON,-1,-1;P_MUNICIP 'P_MUNICIP' true true false 200 Text 0 0 ,First,#," + PTTW_NO_UTM_Layer + ",P_MUNICIP,-1,-1;P_UPPERT 'P_UPPERT' true true false 150 Text 0 0 ,First,#," + PTTW_NO_UTM_Layer + ",P_UPPERT,-1,-1;P_LOWERT 'P_LOWERT' true true false 200 Text 0 0 ,First,#," + PTTW_NO_UTM_Layer + ",P_LOWERT,-1,-1;ADDRESS 'ADDRESS' true true false 200 Text 0 0 ,First,#," + PTTW_NO_UTM_Layer + ",ADDRESS,-1,-1;CITY 'CITY' true true false 50 Text 0 0 ,First,#," + PTTW_NO_UTM_Layer + ",CITY,-1,-1;PROVINCE 'PROVINCE' true true false 50 Text 0 0 ,First,#," + PTTW_NO_UTM_Layer + ",PROVINCE,-1,-1;POSTALCODE 'POSTALCODE' true true false 50 Text 0 0 ,First,#," + PTTW_NO_UTM_Layer + ",POSTALCODE,-1,-1;PHONE 'PHONE' true true false 50 Text 0 0 ,First,#," + PTTW_NO_UTM_Layer + ",PHONE,-1,-1;SURFGRND 'SURFGRND' true true false 50 Text 0 0 ,First,#," + PTTW_NO_UTM_Layer + ",SURFGRND,-1,-1;SOURCEID 'SOURCEID' true true false 255 Text 0 0 ,First,#," + PTTW_NO_UTM_Layer + ",SOURCEID,-1,-1;EASTING 'EASTING' true true false 8 Double 0 0 ,First,#," + PTTW_NO_UTM_Layer + ",EASTING,-1,-1;NORTHING 'NORTHING' true true false 8 Double 0 0 ,First,#," + PTTW_NO_UTM_Layer + ",NORTHING,-1,-1;UTMZONE 'UTMZONE' true true false 8 Double 0 0 ,First,#," + PTTW_NO_UTM_Layer + ",UTMZONE,-1,-1;MAXL_DAY 'MAXL_DAY' true true false 8 Double 0 0 ,First,#," + PTTW_NO_UTM_Layer + ",MAXL_DAY,-1,-1;DAYS_YEAR 'DAYS_YEAR' true true false 8 Double 0 0 ,First,#," + PTTW_NO_UTM_Layer + ",DAYS_YEAR,-1,-1;HRS_DAYMAX 'HRS_DAYMAX' true true false 8 Double 0 0 ,First,#," + PTTW_NO_UTM_Layer + ",HRS_DAYMAX,-1,-1;L_MINUTE 'L_MINUTE' true true false 8 Double 0 0 ,First,#," + PTTW_NO_UTM_Layer + ",L_MINUTE,-1,-1;AMENDED_BY 'AMENDED_BY' true true false 50 Text 0 0 ,First,#," + PTTW_NO_UTM_Layer + ",AMENDED_BY,-1,-1;EXPIRED_BY 'EXPIRED_BY' true true false 50 Text 0 0 ,First,#," + PTTW_NO_UTM_Layer + ",EXPIRED_BY,-1,-1;PERMIT_END 'PERMIT_END' true true false 8 Date 0 0 ,First,#," + PTTW_NO_UTM_Layer + ",PERMIT_END,-1,-1;ORIGEAST 'ORIGEAST' true true false 8 Double 0 0 ,First,#," + PTTW_NO_UTM_Layer + ",ORIGEAST,-1,-1;ORIGNORTH 'ORIGNORTH' true true false 8 Double 0 0 ,First,#," + PTTW_NO_UTM_Layer + ",ORIGNORTH,-1,-1;ACTIVE 'ACTIVE' true true false 3 Text 0 0 ,First,#," + PTTW_NO_UTM_Layer + ",ACTIVE,-1,-1;MUN_CA_AUT 'MUN_CA_AUT' true true false 50 Text 0 0 ,First,#," + PTTW_NO_UTM_Layer + ",MUN_CA_AUT,-1,-1;REFERENCE 'REFERENCE' true true false 50 Text 0 0 ,First,#," + PTTW_NO_UTM_Layer + ",REFERENCE,-1,-1;LATITUDE 'LATITUDE' true true false 8 Double 0 0 ,First,#," + PTTW_NO_UTM_Layer + ",LATITUDE,-1,-1;LONGITUDE 'LONGITUDE' true true false 8 Double 0 0 ,First,#," + PTTW_NO_UTM_Layer + ",LONGITUDE,-1,-1", "")
arcpy.Delete_management(PTTW_NO_UTM_Layer, "FeatureClass")

# Add Fields to the PTTW layer in NAD 83 and calculate their values. 
PTTW_NAD83 = OUTPUT_GDB + "\\PTTW_NAD83"
arcpy.AddField_management(PTTW_NAD83, "OUTOFUTM", "DOUBLE", "", "", "", "", "NULLABLE", "NON_REQUIRED", "")
arcpy.AddField_management(PTTW_NAD83, "NOUTM", "DOUBLE", "", "", "", "", "NULLABLE", "NON_REQUIRED", "")
arcpy.AddField_management(PTTW_NAD83, "PERMIT_UC", "TEXT", "", "", "50", "", "NULLABLE", "NON_REQUIRED", "")
arcpy.AddField_management(PTTW_NAD83, "FILENO_UC", "TEXT", "", "", "200", "", "NULLABLE", "NON_REQUIRED", "")
arcpy.AddField_management(PTTW_NAD83, "CLNTNM_UC", "TEXT", "", "", "200", "", "NULLABLE", "NON_REQUIRED", "")
arcpy.AddField_management(PTTW_NAD83, "CLNTNO_UC", "TEXT", "", "", "150", "", "NULLABLE", "NON_REQUIRED", "")
arcpy.AddField_management(PTTW_NAD83, "ID", "TEXT", "", "", "500", "", "NULLABLE", "NON_REQUIRED", "")
arcpy.AddField_management(PTTW_NAD83, "LEGEND", "TEXT", "", "", "50", "", "NULLABLE", "NON_REQUIRED", "")
arcpy.CalculateField_management(PTTW_NAD83, "PERMIT_UC", "UCase ( [PERMITNO] )", "VB", "")
arcpy.CalculateField_management(PTTW_NAD83, "FILENO_UC", "UCase ( [FILENO]  )", "VB", "")
arcpy.CalculateField_management(PTTW_NAD83, "CLNTNM_UC", "UCase ( [CLIENTNAME] )", "VB", "")
arcpy.CalculateField_management(PTTW_NAD83, "CLNTNO_UC", "UCase ( [CLIENTNO] )", "VB", "")
expression = "getLegendValue(!ACTIVE!, !SURFGRND!)"
codeblock = "def getLegendValue(active, surfgrnd):\n    if active == 'No':\n        return 'No'\n    else:\n        return 'Yes-' + surfgrnd"
arcpy.CalculateField_management(PTTW_NAD83, "LEGEND", expression, "PYTHON", codeblock)

# Create the feature class for data download page which includes active and inactive permits and some fields are removed. 
arcpy.FeatureClassToFeatureClass_conversion(PTTW_NAD83, OUTPUT_GDB, "PTTW_DataDownload", "", "PERMITNO 'PERMITNO' true true false 50 Text 0 0 ,First,#," +  PTTW_NAD83 + ",PERMITNO,-1,-1;FILENO 'FILENO' true true false 200 Text 0 0 ,First,#," +  PTTW_NAD83 + ",FILENO,-1,-1;CLIENTNAME 'CLIENTNAME' true true false 200 Text 0 0 ,First,#," +  PTTW_NAD83 + ",CLIENTNAME,-1,-1;CLIENTNO 'CLIENTNO' true true false 150 Text 0 0 ,First,#," +  PTTW_NAD83 + ",CLIENTNO,-1,-1;PURPOSECAT 'PURPOSECAT' true true false 200 Text 0 0 ,First,#," +  PTTW_NAD83 + ",PURPOSECAT,-1,-1;SPURPOSE 'SPURPOSE' true true false 200 Text 0 0 ,First,#," +  PTTW_NAD83 + ",SPURPOSE,-1,-1;EXPIRYDATE 'EXPIRYDATE' true true false 8 Date 0 0 ,First,#," +  PTTW_NAD83 + ",EXPIRYDATE,-1,-1;ISSUEDDATE 'ISSUEDDATE' true true false 8 Date 0 0 ,First,#," +  PTTW_NAD83 + ",ISSUEDDATE,-1,-1;RENEWDATE 'RENEWDATE' true true false 50 Text 0 0 ,First,#," +  PTTW_NAD83 + ",RENEWDATE,-1,-1;OLDCTYTWN 'OLDCTYTWN' true true false 200 Text 0 0 ,First,#," +  PTTW_NAD83 + ",OLDCTYTWN,-1,-1;P_LOT 'P_LOT' true true false 150 Text 0 0 ,First,#," +  PTTW_NAD83 + ",P_LOT,-1,-1;P_CON 'P_CON' true true false 150 Text 0 0 ,First,#," +  PTTW_NAD83 + ",P_CON,-1,-1;P_MUNICIP 'P_MUNICIP' true true false 200 Text 0 0 ,First,#," +  PTTW_NAD83 + ",P_MUNICIP,-1,-1;P_UPPERT 'P_UPPERT' true true false 150 Text 0 0 ,First,#," +  PTTW_NAD83 + ",P_UPPERT,-1,-1;P_LOWERT 'P_LOWERT' true true false 200 Text 0 0 ,First,#," +  PTTW_NAD83 + ",P_LOWERT,-1,-1;ADDRESS 'ADDRESS' true true false 200 Text 0 0 ,First,#," +  PTTW_NAD83 + ",ADDRESS,-1,-1;CITY 'CITY' true true false 50 Text 0 0 ,First,#," +  PTTW_NAD83 + ",CITY,-1,-1;PROVINCE 'PROVINCE' true true false 50 Text 0 0 ,First,#," +  PTTW_NAD83 + ",PROVINCE,-1,-1;POSTALCODE 'POSTALCODE' true true false 50 Text 0 0 ,First,#," +  PTTW_NAD83 + ",POSTALCODE,-1,-1;PHONE 'PHONE' true true false 50 Text 0 0 ,First,#," +  PTTW_NAD83 + ",PHONE,-1,-1;SURFGRND 'SURFGRND' true true false 50 Text 0 0 ,First,#," +  PTTW_NAD83 + ",SURFGRND,-1,-1;SOURCEID 'SOURCEID' true true false 255 Text 0 0 ,First,#," +  PTTW_NAD83 + ",SOURCEID,-1,-1;EASTING 'EASTING' true true false 8 Double 0 0 ,First,#," +  PTTW_NAD83 + ",EASTING,-1,-1;NORTHING 'NORTHING' true true false 8 Double 0 0 ,First,#," +  PTTW_NAD83 + ",NORTHING,-1,-1;UTMZONE 'UTMZONE' true true false 8 Double 0 0 ,First,#," +  PTTW_NAD83 + ",UTMZONE,-1,-1;MAXL_DAY 'MAXL_DAY' true true false 8 Double 0 0 ,First,#," +  PTTW_NAD83 + ",MAXL_DAY,-1,-1;DAYS_YEAR 'DAYS_YEAR' true true false 8 Double 0 0 ,First,#," +  PTTW_NAD83 + ",DAYS_YEAR,-1,-1;HRS_DAYMAX 'HRS_DAYMAX' true true false 8 Double 0 0 ,First,#," +  PTTW_NAD83 + ",HRS_DAYMAX,-1,-1;L_MINUTE 'L_MINUTE' true true false 8 Double 0 0 ,First,#," +  PTTW_NAD83 + ",L_MINUTE,-1,-1;AMENDED_BY 'AMENDED_BY' true true false 50 Text 0 0 ,First,#," +  PTTW_NAD83 + ",AMENDED_BY,-1,-1;EXPIRED_BY 'EXPIRED_BY' true true false 50 Text 0 0 ,First,#," +  PTTW_NAD83 + ",EXPIRED_BY,-1,-1;PERMIT_END 'PERMIT_END' true true false 8 Date 0 0 ,First,#," +  PTTW_NAD83 + ",PERMIT_END,-1,-1;ORIGEAST 'ORIGEAST' true true false 8 Double 0 0 ,First,#," +  PTTW_NAD83 + ",ORIGEAST,-1,-1;ORIGNORTH 'ORIGNORTH' true true false 8 Double 0 0 ,First,#," +  PTTW_NAD83 + ",ORIGNORTH,-1,-1;ACTIVE 'ACTIVE' true true false 3 Text 0 0 ,First,#," +  PTTW_NAD83 + ",ACTIVE,-1,-1;MUN_CA_AUT 'MUN_CA_AUT' true true false 50 Text 0 0 ,First,#," +  PTTW_NAD83 + ",MUN_CA_AUT,-1,-1;REFERENCE 'REFERENCE' true true false 50 Text 0 0 ,First,#," +  PTTW_NAD83 + ",REFERENCE,-1,-1;LATITUDE 'LATITUDE' true true false 8 Double 0 0 ,First,#," +  PTTW_NAD83 + ",LATITUDE,-1,-1;LONGITUDE 'LONGITUDE' true true false 8 Double 0 0 ,First,#," +  PTTW_NAD83 + ",LONGITUDE,-1,-1;OUTOFUTM 'OUTOFUTM' true true false 8 Double 0 0 ,First,#," +  PTTW_NAD83 + ",OUTOFUTM,-1,-1;NOUTM 'NOUTM' true true false 8 Double 0 0 ,First,#," +  PTTW_NAD83 + ",NOUTM,-1,-1;PERMIT_UC 'PERMIT_UC' true true false 50 Text 0 0 ,First,#," +  PTTW_NAD83 + ",PERMIT_UC,-1,-1;FILENO_UC 'FILENO_UC' true true false 200 Text 0 0 ,First,#," +  PTTW_NAD83 + ",FILENO_UC,-1,-1;CLNTNM_UC 'CLNTNM_UC' true true false 200 Text 0 0 ,First,#," +  PTTW_NAD83 + ",CLNTNM_UC,-1,-1;CLNTNO_UC 'CLNTNO_UC' true true false 150 Text 0 0 ,First,#," +  PTTW_NAD83 + ",CLNTNO_UC,-1,-1;ID 'ID' true true false 500 Text 0 0 ,First,#," +  PTTW_NAD83 + ",ID,-1,-1;LEGEND 'LEGEND' true true false 50 Text 0 0 ,First,#," +  PTTW_NAD83 + ",LEGEND,-1,-1", "")
PTTW_DataDownload = OUTPUT_GDB + "\\PTTW_DataDownload"
arcpy.DeleteField_management(PTTW_DataDownload, "FILENO;CLIENTNO;ADDRESS;CITY;PROVINCE;POSTALCODE;PHONE;OUTOFUTM;NOUTM;ORIGEAST;ORIGNORTH;MUN_CA_AUT;REFERENCE;PERMIT_UC;FILENO_UC;CLNTNM_UC;CLNTNO_UC;ID;LEGEND")
arcpy.FeatureClassToShapefile_conversion(PTTW_DataDownload, OUTPUT_PATH)

# Compress the shape file for data download page into one zip file named PermitsToTakeWater.zip
zip = zipfile.ZipFile(OUTPUT_PATH + '\\PermitsToTakeWater.zip', 'w', zipfile.ZIP_DEFLATED)
zip.write(OUTPUT_PATH + '\\PTTW_DataDownload.dbf', "PermitsToTakeWater.dbf")
zip.write(OUTPUT_PATH + '\\PTTW_DataDownload.prj', "PermitsToTakeWater.prj")
zip.write(OUTPUT_PATH + '\\PTTW_DataDownload.sbn', "PermitsToTakeWater.sbn")
zip.write(OUTPUT_PATH + '\\PTTW_DataDownload.sbx', "PermitsToTakeWater.sbx")
zip.write(OUTPUT_PATH + '\\PTTW_DataDownload.shp', "PermitsToTakeWater.shp")
zip.write(OUTPUT_PATH + '\\PTTW_DataDownload.shp.xml', "PermitsToTakeWater.shp.xml")
zip.write(OUTPUT_PATH + '\\PTTW_DataDownload.shx', "PermitsToTakeWater.shx")
zip.write(INPUT_PATH + '\\fields_description.txt', "fields_description.txt")
zip.close()

# Remove the shape file for data download page
os.system("del " + OUTPUT_PATH + "\\PTTW_DataDownload.s*")
os.system("del " + OUTPUT_PATH + "\\PTTW_DataDownload.prj")

# Create the feature class for interactive maps which only includes the active permits
arcpy.FeatureClassToFeatureClass_conversion(PTTW_DataDownload, OUTPUT_GDB, "PTTW_DataDownload_Active", "ACTIVE = 'Yes'", "PERMITNO 'PERMITNO' true true false 50 Text 0 0 ,First,#," +  PTTW_DataDownload + ",PERMITNO,-1,-1;CLIENTNAME 'CLIENTNAME' true true false 200 Text 0 0 ,First,#," +  PTTW_DataDownload + ",CLIENTNAME,-1,-1;PURPOSECAT 'PURPOSECAT' true true false 200 Text 0 0 ,First,#," +  PTTW_DataDownload + ",PURPOSECAT,-1,-1;SPURPOSE 'SPURPOSE' true true false 200 Text 0 0 ,First,#," +  PTTW_DataDownload + ",SPURPOSE,-1,-1;EXPIRYDATE 'EXPIRYDATE' true true false 8 Date 0 0 ,First,#," +  PTTW_DataDownload + ",EXPIRYDATE,-1,-1;ISSUEDDATE 'ISSUEDDATE' true true false 8 Date 0 0 ,First,#," +  PTTW_DataDownload + ",ISSUEDDATE,-1,-1;RENEWDATE 'RENEWDATE' true true false 50 Text 0 0 ,First,#," +  PTTW_DataDownload + ",RENEWDATE,-1,-1;OLDCTYTWN 'OLDCTYTWN' true true false 200 Text 0 0 ,First,#," +  PTTW_DataDownload + ",OLDCTYTWN,-1,-1;P_LOT 'P_LOT' true true false 150 Text 0 0 ,First,#," +  PTTW_DataDownload + ",P_LOT,-1,-1;P_CON 'P_CON' true true false 150 Text 0 0 ,First,#," +  PTTW_DataDownload + ",P_CON,-1,-1;P_MUNICIP 'P_MUNICIP' true true false 200 Text 0 0 ,First,#," +  PTTW_DataDownload + ",P_MUNICIP,-1,-1;P_UPPERT 'P_UPPERT' true true false 150 Text 0 0 ,First,#," +  PTTW_DataDownload + ",P_UPPERT,-1,-1;P_LOWERT 'P_LOWERT' true true false 200 Text 0 0 ,First,#," +  PTTW_DataDownload + ",P_LOWERT,-1,-1;SURFGRND 'SURFGRND' true true false 50 Text 0 0 ,First,#," +  PTTW_DataDownload + ",SURFGRND,-1,-1;EASTING 'EASTING' true true false 8 Double 0 0 ,First,#," +  PTTW_DataDownload + ",EASTING,-1,-1;NORTHING 'NORTHING' true true false 8 Double 0 0 ,First,#," +  PTTW_DataDownload + ",NORTHING,-1,-1;UTMZONE 'UTMZONE' true true false 8 Double 0 0 ,First,#," +  PTTW_DataDownload + ",UTMZONE,-1,-1;MAXL_DAY 'MAXL_DAY' true true false 8 Double 0 0 ,First,#," +  PTTW_DataDownload + ",MAXL_DAY,-1,-1;DAYS_YEAR 'DAYS_YEAR' true true false 8 Double 0 0 ,First,#," +  PTTW_DataDownload + ",DAYS_YEAR,-1,-1;HRS_DAYMAX 'HRS_DAYMAX' true true false 8 Double 0 0 ,First,#," +  PTTW_DataDownload + ",HRS_DAYMAX,-1,-1;L_MINUTE 'L_MINUTE' true true false 8 Double 0 0 ,First,#," +  PTTW_DataDownload + ",L_MINUTE,-1,-1;AMENDED_BY 'AMENDED_BY' true true false 50 Text 0 0 ,First,#," +  PTTW_DataDownload + ",AMENDED_BY,-1,-1;EXPIRED_BY 'EXPIRED_BY' true true false 50 Text 0 0 ,First,#," +  PTTW_DataDownload + ",EXPIRED_BY,-1,-1;PERMIT_END 'PERMIT_END' true true false 8 Date 0 0 ,First,#," +  PTTW_DataDownload + ",PERMIT_END,-1,-1;ORIGEAST 'ORIGEAST' true true false 8 Double 0 0 ,First,#," +  PTTW_DataDownload + ",ORIGEAST,-1,-1;ORIGNORTH 'ORIGNORTH' true true false 8 Double 0 0 ,First,#," +  PTTW_DataDownload + ",ORIGNORTH,-1,-1;ACTIVE 'ACTIVE' true true false 3 Text 0 0 ,First,#," +  PTTW_DataDownload + ",ACTIVE,-1,-1;MUN_CA_AUT 'MUN_CA_AUT' true true false 50 Text 0 0 ,First,#," +  PTTW_DataDownload + ",MUN_CA_AUT,-1,-1;REFERENCE 'REFERENCE' true true false 50 Text 0 0 ,First,#," +  PTTW_DataDownload + ",REFERENCE,-1,-1;LATITUDE 'LATITUDE' true true false 8 Double 0 0 ,First,#," +  PTTW_DataDownload + ",LATITUDE,-1,-1;LONGITUDE 'LONGITUDE' true true false 8 Double 0 0 ,First,#," +  PTTW_DataDownload + ",LONGITUDE,-1,-1", "")
PTTW_DataDownload_Active = OUTPUT_GDB + "\\PTTW_DataDownload_Active"
PTTW_Active_WebMercater = OUTPUT_GDB + "\\PTTW_Active_WebMercater"

# Change the projection to Web mercater and delete the active permits layer in NAD 83
arcpy.Project_management(PTTW_DataDownload_Active, PTTW_Active_WebMercater, "PROJCS['WGS_1984_Web_Mercator_Auxiliary_Sphere',GEOGCS['GCS_WGS_1984',DATUM['D_WGS_1984',SPHEROID['WGS_1984',6378137.0,298.257223563]],PRIMEM['Greenwich',0.0],UNIT['Degree',0.0174532925199433]],PROJECTION['Mercator_Auxiliary_Sphere'],PARAMETER['False_Easting',0.0],PARAMETER['False_Northing',0.0],PARAMETER['Central_Meridian',0.0],PARAMETER['Standard_Parallel_1',0.0],PARAMETER['Auxiliary_Sphere_Type',0.0],UNIT['Meter',1.0]]", "NAD_1983_To_WGS_1984_5", "GEOGCS['GCS_North_American_1983',DATUM['D_North_American_1983',SPHEROID['GRS_1980',6378137.0,298.257222101]],PRIMEM['Greenwich',0.0],UNIT['Degree',0.0174532925199433]]")
arcpy.Delete_management(PTTW_DataDownload_Active, "FeatureClass")

# Spatial Join with the watershed layer to get watershed information, remove the PTTW_Active_WebMercater feature class and remove the useless fields in PermitsToTakeWater_Active_Watershed.
PermitsToTakeWater_Active_Watershed =  OUTPUT_GDB + "\\PermitsToTakeWater_Active_Watershed" 
arcpy.SpatialJoin_analysis(PTTW_Active_WebMercater, WSHED_TERT_20110530_Simplify, PermitsToTakeWater_Active_Watershed, "JOIN_ONE_TO_ONE", "KEEP_ALL", "PERMITNO 'PERMITNO' true true false 50 Text 0 0 ,First,#," +  PTTW_Active_WebMercater + ",PERMITNO,-1,-1;CLIENTNAME 'CLIENTNAME' true true false 200 Text 0 0 ,First,#," +  PTTW_Active_WebMercater + ",CLIENTNAME,-1,-1;PURPOSECAT 'PURPOSECAT' true true false 200 Text 0 0 ,First,#," +  PTTW_Active_WebMercater + ",PURPOSECAT,-1,-1;SPURPOSE 'SPURPOSE' true true false 200 Text 0 0 ,First,#," +  PTTW_Active_WebMercater + ",SPURPOSE,-1,-1;EXPIRYDATE 'EXPIRYDATE' true true false 8 Date 0 0 ,First,#," +  PTTW_Active_WebMercater + ",EXPIRYDATE,-1,-1;ISSUEDDATE 'ISSUEDDATE' true true false 8 Date 0 0 ,First,#," +  PTTW_Active_WebMercater + ",ISSUEDDATE,-1,-1;RENEWDATE 'RENEWDATE' true true false 50 Text 0 0 ,First,#," +  PTTW_Active_WebMercater + ",RENEWDATE,-1,-1;OLDCTYTWN 'OLDCTYTWN' true true false 200 Text 0 0 ,First,#," +  PTTW_Active_WebMercater + ",OLDCTYTWN,-1,-1;P_LOT 'P_LOT' true true false 150 Text 0 0 ,First,#," +  PTTW_Active_WebMercater + ",P_LOT,-1,-1;P_CON 'P_CON' true true false 150 Text 0 0 ,First,#," +  PTTW_Active_WebMercater + ",P_CON,-1,-1;P_MUNICIP 'P_MUNICIP' true true false 200 Text 0 0 ,First,#," +  PTTW_Active_WebMercater + ",P_MUNICIP,-1,-1;P_UPPERT 'P_UPPERT' true true false 150 Text 0 0 ,First,#," +  PTTW_Active_WebMercater + ",P_UPPERT,-1,-1;P_LOWERT 'P_LOWERT' true true false 200 Text 0 0 ,First,#," +  PTTW_Active_WebMercater + ",P_LOWERT,-1,-1;SURFGRND 'SURFGRND' true true false 50 Text 0 0 ,First,#," +  PTTW_Active_WebMercater + ",SURFGRND,-1,-1;EASTING 'EASTING' true true false 8 Double 0 0 ,First,#," +  PTTW_Active_WebMercater + ",EASTING,-1,-1;NORTHING 'NORTHING' true true false 8 Double 0 0 ,First,#," +  PTTW_Active_WebMercater + ",NORTHING,-1,-1;UTMZONE 'UTMZONE' true true false 8 Double 0 0 ,First,#," +  PTTW_Active_WebMercater + ",UTMZONE,-1,-1;MAXL_DAY 'MAXL_DAY' true true false 8 Double 0 0 ,First,#," +  PTTW_Active_WebMercater + ",MAXL_DAY,-1,-1;DAYS_YEAR 'DAYS_YEAR' true true false 8 Double 0 0 ,First,#," +  PTTW_Active_WebMercater + ",DAYS_YEAR,-1,-1;HRS_DAYMAX 'HRS_DAYMAX' true true false 8 Double 0 0 ,First,#," +  PTTW_Active_WebMercater + ",HRS_DAYMAX,-1,-1;L_MINUTE 'L_MINUTE' true true false 8 Double 0 0 ,First,#," +  PTTW_Active_WebMercater + ",L_MINUTE,-1,-1;AMENDED_BY 'AMENDED_BY' true true false 50 Text 0 0 ,First,#," +  PTTW_Active_WebMercater + ",AMENDED_BY,-1,-1;EXPIRED_BY 'EXPIRED_BY' true true false 50 Text 0 0 ,First,#," +  PTTW_Active_WebMercater + ",EXPIRED_BY,-1,-1;PERMIT_END 'PERMIT_END' true true false 8 Date 0 0 ,First,#," +  PTTW_Active_WebMercater + ",PERMIT_END,-1,-1;ORIGEAST 'ORIGEAST' true true false 8 Double 0 0 ,First,#," +  PTTW_Active_WebMercater + ",ORIGEAST,-1,-1;ORIGNORTH 'ORIGNORTH' true true false 8 Double 0 0 ,First,#," +  PTTW_Active_WebMercater + ",ORIGNORTH,-1,-1;ACTIVE 'ACTIVE' true true false 3 Text 0 0 ,First,#," +  PTTW_Active_WebMercater + ",ACTIVE,-1,-1;MUN_CA_AUT 'MUN_CA_AUT' true true false 50 Text 0 0 ,First,#," +  PTTW_Active_WebMercater + ",MUN_CA_AUT,-1,-1;REFERENCE 'REFERENCE' true true false 50 Text 0 0 ,First,#," +  PTTW_Active_WebMercater + ",REFERENCE,-1,-1;LATITUDE 'LATITUDE' true true false 8 Double 0 0 ,First,#," +  PTTW_Active_WebMercater + ",LATITUDE,-1,-1;LONGITUDE 'LONGITUDE' true true false 8 Double 0 0 ,First,#," +  PTTW_Active_WebMercater + ",LONGITUDE,-1,-1;IDENT 'IDENT' true true false 8 Text 0 0 ,First,#,"  + WSHED_TERT_20110530_Simplify + ",IDENT,-1,-1;NAME 'NAME' true true false 100 Text 0 0 ,First,#,"  + WSHED_TERT_20110530_Simplify + ",NAME,-1,-1;AVG_USE 'AVG_USE' true true false 8 Text 0 0 ,First,#,"  + WSHED_TERT_20110530_Simplify + ",AVG_USE,-1,-1;SLFLWATUSE 'SLFLWATUSE' true true false 8 Text 0 0 ,First,#,"  + WSHED_TERT_20110530_Simplify + ",SLFLWATUSE,-1,-1;CenLng 'CenLng' true true false 8 Double 0 0 ,First,#,"  + WSHED_TERT_20110530_Simplify + ",CenLng,-1,-1;CenLat 'CenLat' true true false 8 Double 0 0 ,First,#,"  + WSHED_TERT_20110530_Simplify + ",CenLat,-1,-1;Shape_Length 'Shape_Length' false true true 8 Double 0 0 ,First,#,"  + WSHED_TERT_20110530_Simplify + ",Shape_Length,-1,-1;Shape_Area 'Shape_Area' false true true 8 Double 0 0 ,First,#,"  + WSHED_TERT_20110530_Simplify + ",Shape_Area,-1,-1", "IS_WITHIN", "0 Meters", "")
arcpy.Delete_management(PTTW_Active_WebMercater, "FeatureClass")
arcpy.DeleteField_management(PermitsToTakeWater_Active_Watershed, "Join_Count;CenLng;CenLat")

# Remove useless feature classes
arcpy.Delete_management( OUTPUT_GDB + "\\PTTW" , "FeatureClass")
arcpy.Delete_management( OUTPUT_GDB + "\\PTTW_DataDownload" , "FeatureClass")
arcpy.Delete_management( OUTPUT_GDB + "\\PTTW_NO_UTM_Layer" , "FeatureClass")
arcpy.Delete_management( OUTPUT_GDB + "\\PTTW_no_UTM" , "Table")

# Move the PTTW in NAD 83 to a separated GDB and remove it from the PTTW_Search
arcpy.FeatureClassToFeatureClass_conversion(OUTPUT_GDB + "\\PTTW_NAD83", OUTPUT_PATH + "\\PTTW_NAD83.gdb", "PTTW", "", "PERMITNO \"PERMITNO\" true true false 50 Text 0 0 ,First,#," + OUTPUT_GDB + "\\PTTW_NAD83,PERMITNO,-1,-1;FILENO \"FILENO\" true true false 200 Text 0 0 ,First,#," + OUTPUT_GDB + "\\PTTW_NAD83,FILENO,-1,-1;CLIENTNAME \"CLIENTNAME\" true true false 200 Text 0 0 ,First,#," + OUTPUT_GDB + "\\PTTW_NAD83,CLIENTNAME,-1,-1;CLIENTNO \"CLIENTNO\" true true false 150 Text 0 0 ,First,#," + OUTPUT_GDB + "\\PTTW_NAD83,CLIENTNO,-1,-1;PURPOSECAT \"PURPOSECAT\" true true false 200 Text 0 0 ,First,#," + OUTPUT_GDB + "\\PTTW_NAD83,PURPOSECAT,-1,-1;SPURPOSE \"SPURPOSE\" true true false 200 Text 0 0 ,First,#," + OUTPUT_GDB + "\\PTTW_NAD83,SPURPOSE,-1,-1;EXPIRYDATE \"EXPIRYDATE\" true true false 8 Date 0 0 ,First,#," + OUTPUT_GDB + "\\PTTW_NAD83,EXPIRYDATE,-1,-1;ISSUEDDATE \"ISSUEDDATE\" true true false 8 Date 0 0 ,First,#," + OUTPUT_GDB + "\\PTTW_NAD83,ISSUEDDATE,-1,-1;RENEWDATE \"RENEWDATE\" true true false 50 Text 0 0 ,First,#," + OUTPUT_GDB + "\\PTTW_NAD83,RENEWDATE,-1,-1;OLDCTYTWN \"OLDCTYTWN\" true true false 200 Text 0 0 ,First,#," + OUTPUT_GDB + "\\PTTW_NAD83,OLDCTYTWN,-1,-1;P_LOT \"P_LOT\" true true false 150 Text 0 0 ,First,#," + OUTPUT_GDB + "\\PTTW_NAD83,P_LOT,-1,-1;P_CON \"P_CON\" true true false 150 Text 0 0 ,First,#," + OUTPUT_GDB + "\\PTTW_NAD83,P_CON,-1,-1;P_MUNICIP \"P_MUNICIP\" true true false 200 Text 0 0 ,First,#," + OUTPUT_GDB + "\\PTTW_NAD83,P_MUNICIP,-1,-1;P_UPPERT \"P_UPPERT\" true true false 150 Text 0 0 ,First,#," + OUTPUT_GDB + "\\PTTW_NAD83,P_UPPERT,-1,-1;P_LOWERT \"P_LOWERT\" true true false 200 Text 0 0 ,First,#," + OUTPUT_GDB + "\\PTTW_NAD83,P_LOWERT,-1,-1;ADDRESS \"ADDRESS\" true true false 200 Text 0 0 ,First,#," + OUTPUT_GDB + "\\PTTW_NAD83,ADDRESS,-1,-1;CITY \"CITY\" true true false 50 Text 0 0 ,First,#," + OUTPUT_GDB + "\\PTTW_NAD83,CITY,-1,-1;PROVINCE \"PROVINCE\" true true false 50 Text 0 0 ,First,#," + OUTPUT_GDB + "\\PTTW_NAD83,PROVINCE,-1,-1;POSTALCODE \"POSTALCODE\" true true false 50 Text 0 0 ,First,#," + OUTPUT_GDB + "\\PTTW_NAD83,POSTALCODE,-1,-1;PHONE \"PHONE\" true true false 50 Text 0 0 ,First,#," + OUTPUT_GDB + "\\PTTW_NAD83,PHONE,-1,-1;SURFGRND \"SURFGRND\" true true false 50 Text 0 0 ,First,#," + OUTPUT_GDB + "\\PTTW_NAD83,SURFGRND,-1,-1;SOURCEID \"SOURCEID\" true true false 255 Text 0 0 ,First,#," + OUTPUT_GDB + "\\PTTW_NAD83,SOURCEID,-1,-1;EASTING \"EASTING\" true true false 8 Double 0 0 ,First,#," + OUTPUT_GDB + "\\PTTW_NAD83,EASTING,-1,-1;NORTHING \"NORTHING\" true true false 8 Double 0 0 ,First,#," + OUTPUT_GDB + "\\PTTW_NAD83,NORTHING,-1,-1;UTMZONE \"UTMZONE\" true true false 8 Double 0 0 ,First,#," + OUTPUT_GDB + "\\PTTW_NAD83,UTMZONE,-1,-1;MAXL_DAY \"MAXL_DAY\" true true false 8 Double 0 0 ,First,#," + OUTPUT_GDB + "\\PTTW_NAD83,MAXL_DAY,-1,-1;DAYS_YEAR \"DAYS_YEAR\" true true false 8 Double 0 0 ,First,#," + OUTPUT_GDB + "\\PTTW_NAD83,DAYS_YEAR,-1,-1;HRS_DAYMAX \"HRS_DAYMAX\" true true false 8 Double 0 0 ,First,#," + OUTPUT_GDB + "\\PTTW_NAD83,HRS_DAYMAX,-1,-1;L_MINUTE \"L_MINUTE\" true true false 8 Double 0 0 ,First,#," + OUTPUT_GDB + "\\PTTW_NAD83,L_MINUTE,-1,-1;AMENDED_BY \"AMENDED_BY\" true true false 50 Text 0 0 ,First,#," + OUTPUT_GDB + "\\PTTW_NAD83,AMENDED_BY,-1,-1;EXPIRED_BY \"EXPIRED_BY\" true true false 50 Text 0 0 ,First,#," + OUTPUT_GDB + "\\PTTW_NAD83,EXPIRED_BY,-1,-1;PERMIT_END \"PERMIT_END\" true true false 8 Date 0 0 ,First,#," + OUTPUT_GDB + "\\PTTW_NAD83,PERMIT_END,-1,-1;ORIGEAST \"ORIGEAST\" true true false 8 Double 0 0 ,First,#," + OUTPUT_GDB + "\\PTTW_NAD83,ORIGEAST,-1,-1;ORIGNORTH \"ORIGNORTH\" true true false 8 Double 0 0 ,First,#," + OUTPUT_GDB + "\\PTTW_NAD83,ORIGNORTH,-1,-1;ACTIVE \"ACTIVE\" true true false 3 Text 0 0 ,First,#," + OUTPUT_GDB + "\\PTTW_NAD83,ACTIVE,-1,-1;MUN_CA_AUT \"MUN_CA_AUT\" true true false 50 Text 0 0 ,First,#," + OUTPUT_GDB + "\\PTTW_NAD83,MUN_CA_AUT,-1,-1;REFERENCE \"REFERENCE\" true true false 50 Text 0 0 ,First,#," + OUTPUT_GDB + "\\PTTW_NAD83,REFERENCE,-1,-1;LATITUDE \"LATITUDE\" true true false 8 Double 0 0 ,First,#," + OUTPUT_GDB + "\\PTTW_NAD83,LATITUDE,-1,-1;LONGITUDE \"LONGITUDE\" true true false 8 Double 0 0 ,First,#," + OUTPUT_GDB + "\\PTTW_NAD83,LONGITUDE,-1,-1;OUTOFUTM \"OUTOFUTM\" true true false 8 Double 0 0 ,First,#," + OUTPUT_GDB + "\\PTTW_NAD83,OUTOFUTM,-1,-1;NOUTM \"NOUTM\" true true false 8 Double 0 0 ,First,#," + OUTPUT_GDB + "\\PTTW_NAD83,NOUTM,-1,-1;PERMIT_UC \"PERMIT_UC\" true true false 50 Text 0 0 ,First,#," + OUTPUT_GDB + "\\PTTW_NAD83,PERMIT_UC,-1,-1;FILENO_UC \"FILENO_UC\" true true false 200 Text 0 0 ,First,#," + OUTPUT_GDB + "\\PTTW_NAD83,FILENO_UC,-1,-1;CLNTNM_UC \"CLNTNM_UC\" true true false 200 Text 0 0 ,First,#," + OUTPUT_GDB + "\\PTTW_NAD83,CLNTNM_UC,-1,-1;CLNTNO_UC \"CLNTNO_UC\" true true false 150 Text 0 0 ,First,#," + OUTPUT_GDB + "\\PTTW_NAD83,CLNTNO_UC,-1,-1;ID \"ID\" true true false 500 Text 0 0 ,First,#," + OUTPUT_GDB + "\\PTTW_NAD83,ID,-1,-1;LEGEND \"LEGEND\" true true false 50 Text 0 0 ,First,#," + OUTPUT_GDB + "\\PTTW_NAD83,LEGEND,-1,-1", "")
arcpy.Delete_management( OUTPUT_GDB + "\\PTTW_NAD83" , "FeatureClass")

# Import watershed layer and watercourse layers
arcpy.FeatureClassToFeatureClass_conversion(WSHED_TERT_20110530_Simplify, OUTPUT_GDB, "WSHED_TERT_20110530_Simplify", "", "IDENT \"IDENT\" true true false 8 Text 0 0 ,First,#," + WSHED_TERT_20110530_Simplify  + ",IDENT,-1,-1;NAME \"NAME\" true true false 100 Text 0 0 ,First,#," + WSHED_TERT_20110530_Simplify  + ",NAME,-1,-1;AVG_USE \"AVG_USE\" true true false 8 Text 0 0 ,First,#," + WSHED_TERT_20110530_Simplify  + ",AVG_USE,-1,-1;SLFLWATUSE \"SLFLWATUSE\" true true false 8 Text 0 0 ,First,#," + WSHED_TERT_20110530_Simplify  + ",SLFLWATUSE,-1,-1;CenLng \"CenLng\" true true false 8 Double 0 0 ,First,#," + WSHED_TERT_20110530_Simplify  + ",CenLng,-1,-1;CenLat \"CenLat\" true true false 8 Double 0 0 ,First,#," + WSHED_TERT_20110530_Simplify  + ",CenLat,-1,-1;Shape_Length \"Shape_Length\" false true true 8 Double 0 0 ,First,#," + WSHED_TERT_20110530_Simplify  + ",Shape_Length,-1,-1;Shape_Area \"Shape_Area\" false true true 8 Double 0 0 ,First,#," + WSHED_TERT_20110530_Simplify  + ",Shape_Area,-1,-1", "")
arcpy.FeatureClassToFeatureClass_conversion(OHN_WATERCOURSE_20110530, OUTPUT_GDB, "OHN_WATERCOURSE_20110530", "", "OFF_NAME \"OFF_NAME\" true true false 100 Text 0 0 ,First,#," + OHN_WATERCOURSE_20110530  + ",OFF_NAME,-1,-1;Shape_Length \"Shape_Length\" false true true 8 Double 0 0 ,First,#," + OHN_WATERCOURSE_20110530  + ",Shape_Length,-1,-1", "")

# Prepare the msd, mxd, and readme.txt
os.system("copy " + INPUT_PATH + "\\PTTW_Search.msd " + OUTPUT_PATH)
os.system("copy " + INPUT_PATH + "\\PTTW_Search.mxd " + OUTPUT_PATH)
f = open (INPUT_PATH + "\\readme_PTTW_Search.txt","r")
data = f.read()
f.close()
import time
dateString = time.strftime("%Y/%m/%d", time.localtime())
data = data.replace("[DATE]", dateString)
f = open (OUTPUT_PATH + "\\readme_PTTW_Search.txt","w")
f.write(data)
f.close()

# Compress the msd, mxd, readme.txt and file geodatabase together into a zip file named PTTW_Search.zip, which will be send to web service publisher. 

target_dir = OUTPUT_PATH + '\\PTTW_Search.gdb'
zip = zipfile.ZipFile(OUTPUT_PATH + '\\PTTW_Search.zip', 'w', zipfile.ZIP_DEFLATED)
rootlen = len(target_dir) + 1
for base, dirs, files in os.walk(target_dir):
   for file in files:
      fn = os.path.join(base, file)
      zip.write(fn, "PTTW_Search.gdb\\" + fn[rootlen:])
zip.write(OUTPUT_PATH + '\\PTTW_Search.msd', "PTTW_Search.msd")
zip.write(OUTPUT_PATH + '\\PTTW_Search.mxd', "PTTW_Search.mxd")
zip.write(OUTPUT_PATH + '\\readme_PTTW_Search.txt', "readme_PTTW_Search.txt")
zip.close()

# Remove the msd, mxd, readme.txt and file geodatabase. 
os.system("del " + OUTPUT_PATH + "\\PTTW_Search.msd")
os.system("del " + OUTPUT_PATH + "\\PTTW_Search.mxd")
os.system("del " + OUTPUT_PATH + "\\readme_PTTW_Search.txt")
os.system("rmdir " + OUTPUT_PATH + "\\PTTW_Search.gdb /s /q")



